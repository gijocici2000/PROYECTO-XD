{% extends 'index.html' %}
{% load static %}

{% block main %}
<div class="container my-4 p-4 rounded" style="background-color: #308a9e; border: 1px solid #333;">
    <h2>Crear Factura</h2>

    <form method="post" id="facturaForm">
        {% csrf_token %}

        <!-- Buscador Cliente -->
        <div class="mb-3">
            <label><b>Buscar Cliente</b></label>
            <input type="text" id="buscador-cliente" class="form-control" placeholder="Buscar cliente por nombre o cédula" autocomplete="off">
            <div id="resultados-cliente" class="list-group mt-1"></div>
            <input type="hidden" name="cliente_id" id="cliente-id" required>
        </div>

        <!-- Buscador Empleado -->
        <div class="mb-3">
            <label><b>Buscar Empleado</b></label>
            <input type="text" id="buscador-empleado" class="form-control" placeholder="Buscar empleado por nombre o cargo" autocomplete="off">
            <div id="resultados-empleado" class="list-group mt-1"></div>
            <input type="hidden" name="empleado_id" id="empleado-id">
        </div>

        <!-- Buscador Sucursal -->
        <div class="mb-3">
            <label><b>Buscar Sucursal</b></label>
            <input type="text" id="buscador-sucursal" class="form-control" placeholder="Buscar sucursal por nombre o dirección" autocomplete="off">
            <div id="resultados-sucursal" class="list-group mt-1"></div>
            <input type="hidden" name="sucursal_id" id="sucursal-id" required>
        </div>

        <hr>
        <h4>Detalle de Productos</h4>
        <table class="table table-bordered">
            <thead class="table-light">
                <tr>
                    <th>Producto</th>
                    <th>Precio unitario</th>
                    <th>Cantidad</th>
                    <th>Subtotal</th>
                    <th>Descuento aplicado (%)</th>
                    <th>IVA</th>
                    <th>Total</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="detalle-productos"></tbody>
        </table>

        <!-- Buscador Producto -->
        <div class="mb-3">
            <label><b>Buscar Producto</b></label>
            <input type="text" id="buscador-producto" class="form-control" placeholder="Buscar producto por nombre o número de serie" autocomplete="off">
            <div id="resultados-producto" class="list-group mt-1"></div>
        </div>

        <div class="row g-2 mb-3">
            <div class="col">
                <input type="number" id="cantidad" class="form-control" placeholder="Cantidad" min="1" value="1">
            </div>
            <div class="col">
                <!-- Descuento solo muestra 0, calculado en backend -->
                <input type="number" id="descuento" class="form-control" placeholder="Descuento %" min="0" max="100" value="0" step="0.01" readonly>
            </div>
            <div class="col">
                <select id="iva-select" class="form-select">
                    {% for iva in ivas %}
                        <option value="{{ iva.id }}" data-porcentaje="{{ iva.porcentaje }}">{{ iva.nombre }} - {{ iva.porcentaje }}%</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col">
                <button type="button" class="btn btn-success" onclick="agregarProducto()">Agregar</button>
            </div>
        </div>

        <input type="hidden" name="productos_json" id="productos_json">

        <div class="mb-3">
            <label for="tipo_pago" class="form-label"><b>Tipo de Pago</b></label>
            <select name="tipo_pago" id="tipo_pago" class="form-select" required>
                <option value="contado" selected>Contado</option>
                <option value="credito">Crédito</option>
                <option value="transferencia">Transferencia Bancaria</option>
            </select>
        </div>

        <button type="submit" class="btn btn-primary">Guardar Factura</button>
    </form>
</div>

<script>
const productos = {{ productos_json|safe }};
const clientes = {{ clientes_json|safe }};
const empleados = {{ empleados_json|safe }};
const sucursales = {{ sucursales_json|safe }};

let productoSeleccionado = null;
let productosFactura = [];

function configurarBuscador(inputId, resultadosId, datos, callback, camposMostrar = ['nombre']) {
    const input = document.getElementById(inputId);
    const resultadosDiv = document.getElementById(resultadosId);

    input.addEventListener('input', () => {
        const query = input.value.trim().toLowerCase();
        resultadosDiv.innerHTML = '';

        if (!query) return;

        const resultados = datos.filter(item =>
            camposMostrar.some(campo =>
                item[campo]?.toString().toLowerCase().includes(query)
            )
        );

        resultados.forEach(item => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'list-group-item list-group-item-action';
            btn.textContent = camposMostrar.map(c => item[c]).join(' - ');

            btn.onclick = () => {
                callback(item);
                resultadosDiv.innerHTML = '';
            };
            resultadosDiv.appendChild(btn);
        });

        if (resultados.length === 0) {
            resultadosDiv.innerHTML = '<div class="list-group-item disabled">Sin resultados</div>';
        }
    });

    document.addEventListener('click', e => {
        if (!input.contains(e.target) && !resultadosDiv.contains(e.target)) {
            resultadosDiv.innerHTML = '';
        }
    });
}

// Configurar buscadores
configurarBuscador('buscador-cliente', 'resultados-cliente', clientes, c => {
    document.getElementById('buscador-cliente').value = c.nombre;
    document.getElementById('cliente-id').value = c.id;
}, ['nombre', 'cedula']);

configurarBuscador('buscador-empleado', 'resultados-empleado', empleados, e => {
    document.getElementById('buscador-empleado').value = e.nombre;
    document.getElementById('empleado-id').value = e.id;
}, ['nombre', 'cargo']);

configurarBuscador('buscador-sucursal', 'resultados-sucursal', sucursales, s => {
    document.getElementById('buscador-sucursal').value = s.nombre;
    document.getElementById('sucursal-id').value = s.id;
}, ['nombre', 'direccion']);

configurarBuscador('buscador-producto', 'resultados-producto', productos, p => {
    productoSeleccionado = p;
    document.getElementById('buscador-producto').value = p.nombre;
    document.getElementById('descuento').value = '0';
});

function agregarProducto() {
    if (!productoSeleccionado) return alert("Seleccione un producto.");

    const cantidad = parseInt(document.getElementById('cantidad').value);
    const ivaSelect = document.getElementById('iva-select');
    const ivaPorcentaje = parseFloat(ivaSelect.options[ivaSelect.selectedIndex].dataset.porcentaje) || 0;
    const ivaId = ivaSelect.value;

    if (isNaN(cantidad) || cantidad <= 0) return alert("Ingrese cantidad válida.");

    const precioUnitario = parseFloat(productoSeleccionado.precio);
    const subtotal = precioUnitario * cantidad;
    const ivaMonto = subtotal * (ivaPorcentaje / 100);
    const total = subtotal + ivaMonto;

    productosFactura.push({
        id: productoSeleccionado.id,
        nombre: productoSeleccionado.nombre,
        precio: precioUnitario.toFixed(2),
        cantidad: cantidad,
        subtotal: subtotal.toFixed(2),
        descuento: "0.00",
        iva_valor: ivaMonto.toFixed(2),
        iva_id: ivaId,
        total: total.toFixed(2)
    });

    actualizarTabla();
    limpiarCamposProducto();
}

function actualizarTabla() {
    const tbody = document.getElementById('detalle-productos');
    tbody.innerHTML = '';

    productosFactura.forEach((p, i) => {
        tbody.innerHTML += `
            <tr>
                <td>${p.nombre}</td>
                <td>${p.precio}</td>
                <td>${p.cantidad}</td>
                <td>${p.subtotal}</td>
                <td>${p.descuento}</td>
                <td>${p.iva_valor}</td>
                <td>${p.total}</td>
                <td><button type="button" class="btn btn-danger btn-sm" onclick="eliminarProducto(${i})">Eliminar</button></td>
            </tr>
        `;
    });

    document.getElementById('productos_json').value = JSON.stringify(productosFactura);
}

function limpiarCamposProducto() {
    document.getElementById('buscador-producto').value = '';
    document.getElementById('cantidad').value = 1;
    document.getElementById('descuento').value = 0;
    productoSeleccionado = null;
}

function eliminarProducto(index) {
    if (confirm("¿Eliminar este producto?")) {
        productosFactura.splice(index, 1);
        actualizarTabla();
    }
}

document.getElementById('facturaForm').addEventListener('submit', e => {
    if (!document.getElementById('cliente-id').value) {
        e.preventDefault();
        alert('Seleccione un cliente válido.');
        return;
    }
    if (!document.getElementById('sucursal-id').value) {
        e.preventDefault();
        alert('Seleccione una sucursal válida.');
        return;
    }
    if (productosFactura.length === 0) {
        e.preventDefault();
        alert('Debe agregar al menos un producto.');
        return;
    }
});
</script>

{% if request.GET.pdf_factura %}
<script>
  window.onload = function() {
    const facturaId = "{{ request.GET.pdf_factura }}";
    const urlPDF = "{% url 'exportar_pdf_factura' %}?factura_id=" + facturaId;
    window.open(urlPDF, '_blank');
  }
</script>
{% endif %}

{% endblock %}
