{% extends 'index.html' %}

{% block main %}
<div class="container mt-4 text-light">
  <h2 class="text-center mb-4 text-primary"><b>Agregar / Actualizar Producto</b></h2>

  {% if mensaje %}
    <div class="alert alert-info text-dark text-center fw-bold">{{ mensaje }}</div>
  {% endif %}

  <form method="post" id="form-producto" class="bg-dark p-4 rounded shadow">
    {% csrf_token %}
    <div class="row g-3">
      <div class="col-md-4">
        {{ form_Producto.numero_serie.label_tag }}
        {{ form_Producto.numero_serie }}
      </div>
      <div class="col-md-4">
        {{ form_Producto.nombre.label_tag }}
        {{ form_Producto.nombre }}
      </div>
      <div class="col-md-4">
        {{ form_Producto.modelo.label_tag }}
        {{ form_Producto.modelo }}
      </div>
      <div class="col-md-4">
        {{ form_Producto.color.label_tag }}
        {{ form_Producto.color }}
      </div>
      <div class="col-md-4">
        {{ form_Producto.categoria.label_tag }}
        {{ form_Producto.categoria }}
      </div>
      <div class="col-md-4">
        {{ form_Producto.unidad.label_tag }}
        {{ form_Producto.unidad }}
      </div>
      <div class="col-md-4">
        {{ form_Producto.precio.label_tag }}
        {{ form_Producto.precio }}
      </div>
    </div>

    <div class="mt-4 text-center">
      <button type="submit" class="btn btn-success px-4">Guardar Producto</button>
    </div>
  </form>

  {% if stock_actual %}
    <div class="alert alert-warning mt-3 text-dark text-center">
      <b>Stock actualizado:</b> {{ stock_actual }}
    </div>
  {% endif %}

  <hr class="border-light my-4">
  <h5 class="text-primary">Productos registrados (nombre y stock)</h5>
  <pre class="bg-light text-dark p-3 rounded small">{{ productos_json }}</pre>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const numeroSerieInput = document.getElementById("id_numero_serie");

  numeroSerieInput.addEventListener("blur", function () {
    const numeroSerie = numeroSerieInput.value.trim();
    if (!numeroSerie) return;

    fetch(`/producto/crear/?numero_serie=${encodeURIComponent(numeroSerie)}`, {
      headers: {
        'X-Requested-With': 'XMLHttpRequest'
      }
    })
      .then(response => response.json())
      .then(data => {
        const campos = {
          nombre: document.getElementById("id_nombre"),
          modelo: document.getElementById("id_modelo"),
          color: document.getElementById("id_color"),
          categoria: document.getElementById("id_categoria"),
          precio: document.getElementById("id_precio"),
          unidad: document.getElementById("id_unidad"),
        };

        if (data.existe) {
          campos.nombre.value = data.nombre || '';
          campos.modelo.value = data.modelo || '';
          campos.color.value = data.color || '';
          campos.categoria.value = data.categoria || '';
          campos.precio.value = data.precio || '';
          // Unidad no se actualiza autom√°ticamente, porque es cantidad a ingresar

          // Deshabilitar campos que no deben cambiarse
          campos.nombre.readOnly = true;
          campos.modelo.readOnly = true;
          campos.color.readOnly = true;
          campos.precio.readOnly = true;
          campos.categoria.readOnly = true;

          for (const campo of Object.values(campos)) {
            campo.classList.add('bg-light', 'text-muted');
          }

          // Mostrar stock actual en la alerta fuera del formulario
          const stockAlert = document.querySelector('.alert-warning');
          if (stockAlert) {
            stockAlert.innerHTML = `<b>Stock actual:</b> ${data.stock}`;
          }

        } else {
          // Producto no existe: limpiar campos y habilitar todos
          for (const campo of Object.values(campos)) {
            campo.readOnly = false;
            campo.value = '';
            campo.classList.remove('bg-light', 'text-muted');
          }

          // Limpiar stock actual
          const stockAlert = document.querySelector('.alert-warning');
          if (stockAlert) {
            stockAlert.innerHTML = '';
          }
        }
      })
      .catch(err => console.error("Error en autocompletado:", err));
  });
});
</script>
{% endblock %}
